#!/usr/bin/env node

var fs = require('fs');
var path = require('path');
var mongo = require('mongoskin');

var minify = require('../lib/ext/minify.json').minify;

if (process.argv.length < 5) {
  console.log("usage: " + path.basename(process.argv[1]) + 
              " server_config_file sign_name sign_config_file");
  process.exit(1);
}

var serverConfig = JSON.parse(minify(
                                fs.readFileSync(process.argv[2]).toString()
                              ));
var signName = process.argv[3];
var signConfig = JSON.parse(minify(
                              fs.readFileSync(process.argv[4]).toString()
                            ));
var db = mongo.db(serverConfig.db.host + ':' + serverConfig.db.port + '/' +
                  serverConfig.db.db);

var collection = db.collection('sign_configs');

collection.update({'sign_name': signName}, {'sign_name': signName,
                   'config': signConfig}, {'upsert': true},
                  function(err) {
                    if (err) {
                      console.log(err);
                      process.exit(1);
                    } else {
                      console.log("Updated configuration for sign " + signName + ".");
                      process.exit(0);
                    }
                  });